<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discogs Vinyl Discovery App</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icons
        const Filter = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"></polygon>
            </svg>
        );

        const Heart = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
        );

        const Music = ({ size = 48 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
        );

        const Settings = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const ThumbsUp = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
            </svg>
        );

        const ThumbsDown = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2 2 0 0 1-2 2H17"></path>
            </svg>
        );

        const SkipForward = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="5,4 15,12 5,20"></polygon>
                <line x1="19" y1="5" x2="19" y2="19"></line>
            </svg>
        );

        const SkipBack = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="19,20 9,12 19,4"></polygon>
                <line x1="5" y1="19" x2="5" y2="5"></line>
            </svg>
        );

        const Loader = () => (
            <svg className="loading w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="2" x2="12" y2="6"></line>
                <line x1="12" y1="18" x2="12" y2="22"></line>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                <line x1="2" y1="12" x2="6" y2="12"></line>
                <line x1="18" y1="12" x2="22" y2="12"></line>
                <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
            </svg>
        );

        // Configuration Component
        const ConfigPanel = ({ config, setConfig, onSave, onCancel }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-gray-800 rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                    <h2 className="text-xl font-bold mb-4">App Configuration</h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Discogs Token *</label>
                            <input
                                type="text"
                                value={config.token}
                                onChange={(e) => setConfig({...config, token: e.target.value})}
                                className="w-full p-2 bg-gray-700 rounded text-white"
                                placeholder="Your Discogs API token"
                            />
                            <p className="text-xs text-gray-400 mt-1">
                                Get from: discogs.com → Settings → Developers
                            </p>
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Seller Username *</label>
                            <input
                                type="text"
                                value={config.seller}
                                onChange={(e) => setConfig({...config, seller: e.target.value})}
                                className="w-full p-2 bg-gray-700 rounded text-white"
                                placeholder="mezabel"
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium mb-1">Year From</label>
                                <input
                                    type="number"
                                    value={config.year_from}
                                    onChange={(e) => setConfig({...config, year_from: parseInt(e.target.value) || 1990})}
                                    className="w-full p-2 bg-gray-700 rounded text-white"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Max Price ($)</label>
                                <input
                                    type="number"
                                    value={config.max_price}
                                    onChange={(e) => setConfig({...config, max_price: parseInt(e.target.value) || 20})}
                                    className="w-full p-2 bg-gray-700 rounded text-white"
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium mb-1">Fetch Items</label>
                                <input
                                    type="number"
                                    value={config.fetch_items}
                                    onChange={(e) => setConfig({...config, fetch_items: parseInt(e.target.value) || 1000})}
                                    className="w-full p-2 bg-gray-700 rounded text-white"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Top Items</label>
                                <input
                                    type="number"
                                    value={config.top_items}
                                    onChange={(e) => setConfig({...config, top_items: parseInt(e.target.value) || 50})}
                                    className="w-full p-2 bg-gray-700 rounded text-white"
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Sort Method</label>
                            <select
                                value={config.sort_method}
                                onChange={(e) => setConfig({...config, sort_method: e.target.value})}
                                className="w-full p-2 bg-gray-700 rounded text-white"
                            >
                                <option value="price_low_to_high">Price: Low to High</option>
                                <option value="newest">Newest First</option>
                            </select>
                        </div>

                        <div>
                            <label className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={config.twelve_inch_only}
                                    onChange={(e) => setConfig({...config, twelve_inch_only: e.target.checked})}
                                    className="mr-2"
                                />
                                12" Only (Electronic Music)
                            </label>
                        </div>
                    </div>

                    <div className="flex space-x-3 mt-6">
                        <button
                            onClick={onSave}
                            className="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium"
                            disabled={!config.token || !config.seller}
                        >
                            Save & Load Data
                        </button>
                        <button
                            onClick={onCancel}
                            className="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg font-medium"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        );

        // Main App Component
        const DiscogsMusicApp = () => {
            const [currentTrack, setCurrentTrack] = useState(0);
            const [tracks, setTracks] = useState([]);
            const [likedTracks, setLikedTracks] = useState([]);
            const [showFilters, setShowFilters] = useState(false);
            const [showLiked, setShowLiked] = useState(false);
            const [showConfig, setShowConfig] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [autoPlay, setAutoPlay] = useState(false);

            // Configuration state
            const [config, setConfig] = useState(() => {
                const saved = localStorage.getItem('discogsConfig');
                return saved ? JSON.parse(saved) : {
                    token: '',
                    seller: 'mezabel',
                    year_from: 1990,
                    max_price: 20,
                    fetch_items: 1000,
                    top_items: 50,
                    sort_method: 'price_low_to_high',
                    twelve_inch_only: true
                };
            });

            // Discogs API functions
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const fetchWithRetry = async (url, options, retries = 3) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            ...options,
                            headers: {
                                'Authorization': `Discogs token=${config.token}`,
                                'User-Agent': 'VinylDiscoveryApp/1.0',
                                ...options.headers
                            }
                        });

                        if (response.status === 429) {
                            await delay(2000 * (i + 1));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        return response;
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await delay(1000);
                    }
                }
            };

            const fetchInventoryPage = async (page = 1, perPage = 100) => {
                const url = `https://api.discogs.com/users/${config.seller}/inventory?per_page=${perPage}&page=${page}`;
                const response = await fetchWithRetry(url, {});
                return response.json();
            };

            const fetchReleaseDetails = async (releaseId) => {
                try {
                    const url = `https://api.discogs.com/releases/${releaseId}`;
                    const response = await fetchWithRetry(url, {});
                    return response.json();
                } catch (err) {
                    console.warn(`Failed to fetch release ${releaseId}:`, err);
                    return null;
                }
            };

            const isVinylFormat = (formats) => {
                if (!formats || !Array.isArray(formats)) return false;
                const vinylFormats = config.twelve_inch_only ? 
                    formats.filter(f => f.includes('12"')) :
                    formats.filter(f => /^(7"|10"|12"|LP)/.test(f));
                return vinylFormats.length > 0;
            };

            const convertToEmbedUrl = (url) => {
                if (!url) return null;
                
                if (url.includes('youtube.com/watch')) {
                    const videoId = url.match(/[?&]v=([^&]+)/)?.[1];
                    return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
                } else if (url.includes('youtu.be/')) {
                    const videoId = url.split('youtu.be/')[1]?.split('?')[0];
                    return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
                }
                
                return null;
            };

            const loadDiscogsData = async () => {
                if (!config.token || !config.seller) {
                    setError('Please configure your Discogs token and seller name');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    console.log('Starting Discogs data fetch...');
                    
                    // Step 1: Fetch inventory
                    const allListings = [];
                    let page = 1;
                    let totalFetched = 0;

                    while (totalFetched < config.fetch_items) {
                        console.log(`Fetching page ${page}...`);
                        const pageData = await fetchInventoryPage(page, 100);
                        
                        if (!pageData.listings || pageData.listings.length === 0) break;
                        
                        allListings.push(...pageData.listings);
                        totalFetched += pageData.listings.length;
                        
                        if (page >= (pageData.pagination?.pages || 1)) break;
                        page++;
                        
                        await delay(1100); // Rate limiting
                    }

                    console.log(`Fetched ${allListings.length} total listings`);

                    // Step 2: Filter listings
                    const filtered = allListings.filter(item => {
                        const price = parseFloat(item.price?.value) || 0;
                        const year = parseInt(item.release?.year) || 0;
                        const formats = item.release?.format || [];
                        
                        return year >= config.year_from && 
                               price <= config.max_price && 
                               isVinylFormat(formats);
                    });

                    console.log(`${filtered.length} items after filtering`);

                    // Step 3: Calculate want-to-have ratio and sort
                    const withRatios = filtered.map(item => {
                        const wantlist = parseInt(item.release?.stats?.community?.in_wantlist) || 0;
                        const collection = parseInt(item.release?.stats?.community?.in_collection) || 0;
                        const ratio = wantlist / (collection + 1);
                        
                        return {
                            ...item,
                            want_to_have_ratio: ratio,
                            wantlist_count: wantlist,
                            collection_count: collection
                        };
                    });

                    const sorted = withRatios.sort((a, b) => b.want_to_have_ratio - a.want_to_have_ratio);
                    const topItems = sorted.slice(0, config.top_items);

                    console.log(`Processing top ${topItems.length} items...`);

                    // Step 4: Fetch additional details (genres, videos) for top items
                    const processedTracks = [];
                    for (let i = 0; i < topItems.length; i++) {
                        const item = topItems[i];
                        console.log(`Processing item ${i + 1}/${topItems.length}: ${item.release?.title}`);

                        let releaseDetails = null;
                        if (item.release?.id) {
                            releaseDetails = await fetchReleaseDetails(item.release.id);
                            await delay(1100);
                        }

                        const formats = item.release?.format || [];
                        const formatString = formats.join(', ');

                        const track = {
                            id: item.id || i,
                            title: item.release?.title || 'Unknown Title',
                            artist: item.release?.artist || 'Unknown Artist',
                            label: Array.isArray(item.release?.label) ? 
                                   item.release.label[0] : 
                                   (item.release?.label || 'Unknown Label'),
                            year: item.release?.year || 'Unknown',
                            price: parseFloat(item.price?.value) || 0,
                            genre: releaseDetails?.genres?.join(', ') || 'Unknown',
                            style: releaseDetails?.styles?.join(', ') || 'Unknown',
                            format: formatString || 'Unknown',
                            videoUrl: null,
                            wantlist: item.wantlist_count,
                            collection: item.collection_count,
                            ratio: item.want_to_have_ratio,
                            discogsUrl: item.uri || `https://www.discogs.com/release/${item.release?.id}`
                        };

                        // Try to get video URL
                        if (releaseDetails?.videos && releaseDetails.videos.length > 0) {
                            const videoUrl = releaseDetails.videos[0].uri;
                            track.videoUrl = convertToEmbedUrl(videoUrl);
                        }

                        processedTracks.push(track);
                    }

                    console.log(`Loaded ${processedTracks.length} tracks successfully!`);
                    setTracks(processedTracks);
                    setCurrentTrack(0);

                } catch (err) {
                    console.error('Error loading Discogs data:', err);
                    setError(`Failed to load data: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // Load saved data on start
            useEffect(() => {
                const savedTracks = localStorage.getItem('discogsTracksCache');
                const savedLiked = localStorage.getItem('likedTracks');
                
                if (savedTracks) {
                    try {
                        setTracks(JSON.parse(savedTracks));
                    } catch (e) {
                        console.warn('Failed to load cached tracks');
                    }
                }
                
                if (savedLiked) {
                    try {
                        setLikedTracks(JSON.parse(savedLiked));
                    } catch (e) {
                        console.warn('Failed to load liked tracks');
                    }
                }

                // Show config if no token is set
                if (!config.token) {
                    setShowConfig(true);
                }
            }, []);

            // Save configuration
            const saveConfig = async () => {
                localStorage.setItem('discogsConfig', JSON.stringify(config));
                setShowConfig(false);
                await loadDiscogsData();
            };

            // Save tracks to cache when they change
            useEffect(() => {
                if (tracks.length > 0) {
                    localStorage.setItem('discogsTracksCache', JSON.stringify(tracks));
                }
            }, [tracks]);

            const handleLike = (liked) => {
                const track = tracks[currentTrack];
                if (liked && !likedTracks.find(t => t.id === track.id)) {
                    const newLiked = [...likedTracks, track];
                    setLikedTracks(newLiked);
                    localStorage.setItem('likedTracks', JSON.stringify(newLiked));
                }
                nextTrack();
            };

            const nextTrack = () => {
                setCurrentTrack(prev => Math.min(prev + 1, tracks.length - 1));
            };

            const prevTrack = () => {
                setCurrentTrack(prev => Math.max(prev - 1, 0));
            };

            const skipTracks = (count) => {
                setCurrentTrack(prev => Math.min(prev + count, tracks.length - 1));
            };

            const goToLikedTrack = (likedTrack) => {
                const index = tracks.findIndex(t => t.id === likedTrack.id);
                if (index !== -1) {
                    setCurrentTrack(index);
                    setShowLiked(false);
                }
            };

            const track = tracks[currentTrack];

            // Show configuration panel if needed
            if (showConfig) {
                return (
                    <div className="max-w-md mx-auto bg-gray-900 text-white min-h-screen">
                        <ConfigPanel 
                            config={config}
                            setConfig={setConfig}
                            onSave={saveConfig}
                            onCancel={() => setShowConfig(false)}
                        />
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto bg-gray-900 text-white min-h-screen">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-purple-600 to-blue-600 p-4">
                        <h1 className="text-xl font-bold text-center">{config.seller}'s Vinyl</h1>
                        <p className="text-center text-sm opacity-80">
                            {config.year_from}+ • ≤${config.max_price} • Top {config.top_items}
                        </p>
                    </div>

                    {/* Controls Bar */}
                    <div className="flex justify-between items-center p-4 bg-gray-800">
                        <button
                            onClick={() => setShowFilters(!showFilters)}
                            className="flex items-center space-x-2 px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors"
                        >
                            <Filter size={16} />
                            <span>Filters</span>
                        </button>
                        
                        <button
                            onClick={() => setShowLiked(!showLiked)}
                            className="flex items-center space-x-2 px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors"
                        >
                            <Heart size={16} />
                            <span>{likedTracks.length}</span>
                        </button>

                        <button
                            onClick={() => setShowConfig(true)}
                            className="flex items-center space-x-2 px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors"
                        >
                            <Settings size={16} />
                        </button>
                    </div>

                    {/* Loading State */}
                    {loading && (
                        <div className="p-8 text-center">
                            <div className="flex items-center justify-center mb-4">
                                <Loader />
                            </div>
                            <p>Loading Discogs data...</p>
                            <p className="text-sm text-gray-400 mt-2">This may take a few minutes</p>
                        </div>
                    )}

                    {/* Error State */}
                    {error && (
                        <div className="p-4 bg-red-900 text-red-100 mx-4 rounded-lg">
                            <p className="font-semibold">Error:</p>
                            <p className="text-sm">{error}</p>
                            <button 
                                onClick={() => setShowConfig(true)}
                                className="mt-2 px-3 py-1 bg-red-700 rounded text-sm hover:bg-red-600"
                            >
                                Check Configuration
                            </button>
                        </div>
                    )}

                    {/* No Data State */}
                    {!loading && !error && tracks.length === 0 && (
                        <div className="p-8 text-center">
                            <Music size={64} className="mx-auto mb-4 opacity-50" />
                            <p className="mb-4">No tracks loaded</p>
                            <button 
                                onClick={() => setShowConfig(true)}
                                className="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700"
                            >
                                Configure App
                            </button>
                        </div>
                    )}

                    {/* Filters Panel */}
                    {showFilters && (
                        <div className="bg-gray-800 p-4 border-b border-gray-700">
                            <h3 className="font-semibold mb-2">Settings</h3>
                            <div className="space-y-2 text-sm">
                                <label className="flex items-center">
                                    <input 
                                        type="checkbox" 
                                        checked={autoPlay}
                                        onChange={(e) => setAutoPlay(e.target.checked)}
                                        className="mr-2" 
                                    />
                                    Auto-play Videos
                                </label>
                                <button 
                                    onClick={() => loadDiscogsData()}
                                    className="w-full mt-2 px-3 py-2 bg-blue-600 rounded hover:bg-blue-700"
                                    disabled={loading}
                                >
                                    Refresh Data
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Liked Tracks Panel */}
                    {showLiked && (
                        <div className="bg-gray-800 p-4 border-b border-gray-700 max-h-60 overflow-y-auto">
                            <h3 className="font-semibold mb-2">Liked Tracks ({likedTracks.length})</h3>
                            {likedTracks.length === 0 ? (